% ..:: Page geometry ::..

\usepackage{geometry}

\ExplSyntaxOn
\tl_set:Nn \l_sidemargin_dim {1.5cm}
\tl_set:Nn \l_topmargin_dim {2.2cm}
\tl_set:Nn \l_botmargin_dim {1.6cm}
\tl_set:Nn \l_footmargin_dim {6mm}
\tl_set:Nn \l_columnsep_dim {3mm}
\geometry{
  papersize={200mm,273mm},
  twocolumn,
  left=\tl_use:N \l_sidemargin_dim,
  right=\tl_use:N \l_sidemargin_dim,
  top=\tl_use:N \l_topmargin_dim,
  bottom=\tl_use:N \l_botmargin_dim,
  footskip=\tl_use:N \l_footmargin_dim,
  columnsep=\tl_use:N \l_columnsep_dim
}
\ExplSyntaxOff

% ..:: Section titles ::..

\usepackage{helvet}
\titleformat{\section}{%
  \normalfont\fontsize{10}{12}%
  \sffamily\bfseries\MakeUppercase}{}{0cm}{#1}
\titlespacing*{\section}{0cm}{4mm}{0mm}

\titleformat{\subsection}{%
  \normalfont\fontsize{10}{12}%
  \sffamily\bfseries\slshape}{}{0cm}{#1}
\titlespacing*{\subsection}{0cm}{4mm}{0mm}

% ..:: Header and footer ::..

\usepackage{fontawesome}

\ExplSyntaxOn
\tl_new:N \l_csm_date
\tl_set:Nn \l_csm_date {}

\newcommand{\csmdate}[1]{
  \tl_set:Nn \l_csm_date {#1}
}

\fancypagestyle{csmfancy}{%
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
  \fancyfoot[LO]{%
    \sffamily%
    \fontsize{9}{11}%
    \textbf{\thepage}~~%
    \fontsize{6}{8}%
    \textbf{IEEE~CONTROL~SYSTEMS}~~%
    \tikz[outer~sep=0,inner~sep=0]{%
      \node[scale=0.8] at (0,0) {\faChevronRight};%
      \node[scale=0.8] at (0.4em,0) {\faChevronRight};}%
    {\normalfont\sffamily{}~\tl_use:N \l_csm_date}%
  }%
  \fancyfoot[RE]{%
    \fontsize{6}{8}%
    \sffamily%
    {\tl_use:N \l_csm_date}~%
    \tikz[outer~sep=0,inner~sep=0]{%
      \node[scale=0.8] at (0,0) {\faChevronLeft};%
      \node[scale=0.8] at (0.4em,0) {\faChevronLeft};}%
    \textbf{~IEEE~CONTROL~SYSTEMS}%
    \fontsize{9}{11}%
    \textbf{~~\thepage}%
  }%
}
\pagestyle{csmfancy}
\ExplSyntaxOff

% ..:: Equations ::..

\allowdisplaybreaks

% ..:: Figures ::..

\ExplSyntaxOn
\makeatletter

% One-column figure
\renewenvironment{figure}[1][tbp]
{\@float{figure}[#1]}
{\end@float}

% Two-column figure
\renewenvironment{figure*}[1][tbp]
{\@dblfloat{figure}[#1]}
{\end@dblfloat}

% Figure selector
\newenvironment{figure@internal}[2][tbp]{%
  \def\fig@width{#2}%
  \ifthenelse{\equal{\fig@width}{}}{%
    \begin{figure}[#1]}{\begin{figure*}[#1]}}{%
      \ifthenelse{\equal{\fig@width}{}}{%
      \end{figure}}{\end{figure*}}}

\makeatother
\ExplSyntaxOff

% ..:: Referencing ::..

\makeatletter

% Source: https://tex.stackexchange.com/a/168835/90535
\let\oldhypertarget\hypertarget
\renewcommand{\hypertarget}[2]{%
  \oldhypertarget{#1}{#2}%
  \protected@write\@mainaux{}{%
    \string\expandafter\string\gdef
    \string\csname\string\detokenize{#1}\string\endcsname{#2}%
  }%
}

\newcommand{\csmhyperlink}[1]{%
  \hyperlink{#1}{\csname #1\endcsname}%
}

\makeatother

% ..:: Sidebars ::..

\ExplSyntaxOn
\makeatletter

\tl_new:N \l_csm_sidebar_title_tl
\tl_new:N \l_csm_sidebar_label_tl
\tl_new:N \l_csm_sidebar_pos_tl
\tl_new:N \l_csm_sidebar_cols_tl

\define@key{csm@sidebar@keys}{title}{\tl_set:Nn \l_csm_sidebar_title_tl {#1}}
\define@key{csm@sidebar@keys}{label}{\tl_set:Nn \l_csm_sidebar_label_tl {#1}}
\define@key{csm@sidebar@keys}{position}{\tl_set:Nn \l_csm_sidebar_pos_tl {#1}}
\define@key{csm@sidebar@keys}{columns}{\tl_set:Nn \l_csm_sidebar_cols_tl {#1}}

\newcounter{equation@mem}%
\newcounter{table@mem}%
\newcounter{figure@mem}%

\newsavebox{\sidebar@box}

\newenvironment{sidebar}[1][]{%
  \setkeys{csm@sidebar@keys}{title=,#1}%
  \setkeys{csm@sidebar@keys}{label=,#1}%
  \setkeys{csm@sidebar@keys}{position=,#1}%
  \setkeys{csm@sidebar@keys}{columns=2,#1}%
  \edef\fig@pos{\tl_use:N \l_csm_sidebar_pos_tl}
  \pgfmathparse{\tl_use:N \l_csm_sidebar_cols_tl ==1 ? 1:0}
  \ifthenelse{\pgfmathresult>0}{%
    \gdef\figure@width{}
  }{%
    \gdef\figure@width{dbl}
  }
  \edef\begin@sidebar@cmd{{figure@internal}[\fig@pos}
  \expandafter\begin\begin@sidebar@cmd]{\figure@width}%
    \begin{lrbox}{\sidebar@box}
      \begin{minipage}{\linewidth}%
        % >>> Reset equation, table, and figure counters and make labels start
        % with an "S"
        \setcounter{equation@mem}{\value{equation}}%
        \setcounter{table@mem}{\value{table}}%
        \setcounter{figure@mem}{\value{figure}}%
        \setcounter{equation}{0}%
        \setcounter{table}{0}%
        \setcounter{figure}{0}%
        \renewcommand{\theequation}{S\arabic{equation}}%
        \renewcommand{\thetable}{S\arabic{table}}%
        \renewcommand{\thefigure}{S\arabic{figure}}%
        % <<<
        % >>> Make bibliography citations start with an "S"
        \renewbibmacro*{cite}{\printtext[bibhyperref]{%
            \printfield{labelprefix}S\printfield{labelnumber}%
            \ifbool{bbx:subentry}{\printfield{entrysetcount}}{}}}%
        % \DeclareCiteCommand{\cite}[\mkbibbrackets]{\usebibmacro{prenote}}%
        % {S\usebibmacro{citeindex}\usebibmacro{cite}}{\multicitedelim}%
        % {\usebibmacro{postnote}}%
        \DeclareFieldFormat{labelnumberwidth}{S##1.}%
        % <<<
        \xdef\sidebar@title{\tl_use:N \l_csm_sidebar_title_tl}%
        \xdef\sidebar@label{sidebar:\tl_use:N \l_csm_sidebar_label_tl}%
        \label{\sidebar@label}%
        % ..:: Sidebar text begin ::..
        \ifthenelse{\equal{\figure@width}{}}{%
          \textbf{\sffamily~%
            Sidebar:~\hypertarget{\sidebar@label}{\sidebar@title}}%
        }{%
          \begin{multicols}{2}[%
            \textbf{\sffamily Sidebar:~%
              \hypertarget{\sidebar@label}{\sidebar@title}}]%
          }%
        }{%
          % Print the bibliography
          \edef\sidebar@bib@label{sidebar:\tl_use:N \l_csm_sidebar_label_tl}
          \def\bib@print@cmd{\printbibliography[keyword=}
          \expandafter\bib@print@cmd\sidebar@bib@label]
          \ifthenelse{\equal{\figure@width}{figure}}{}{%
          \end{multicols}%
        }%
        % >>> Reset equation, table, and figure counters to body text values
        \setcounter{equation}{\value{equation@mem}}%
        \setcounter{table}{\value{table@mem}}%
        \setcounter{figure}{\value{figure@mem}}%
        % <<<
      \end{minipage}%
    \end{lrbox}%
    \fbox{\usebox{\sidebar@box}}%
  \end{figure@internal}%
}

\newcommand{\sbref}[1]{%
  \xdef\sb@page@number{\getpagerefnumber{sidebar:#1}}%
  \pgfmathparse{\sb@page@number==0 ? 1:0}%
  \ifthenelse{\pgfmathresult>0}{%
    ``\textbf{??}''%
  }{%
    ``\csmhyperlink{sidebar:#1}''%
  }%
}

\makeatother
\ExplSyntaxOff

% ..:: Bibliography ::..

% Font size
\AtBeginBibliography{\small}

% Citation number style and indent after
% Source: https://tex.stackexchange.com/a/411370/90535
\DeclareFieldFormat{labelnumberwidth}{#1.}
\setlength{\biblabelsep}{1mm}

% Remove hanging indent
% Source: https://tex.stackexchange.com/a/400666/90535
\defbibenvironment{bibliography}
{\list
  {\printtext[labelnumberwidth]{%
      \printfield{labelprefix}%
      \printfield{labelnumber}}}
  {\setlength{\labelwidth}{\labelnumberwidth}%
    \setlength{\leftmargin}{0pt}%{\labelwidth}%
    \setlength{\labelsep}{\biblabelsep}%
    \setlength{\itemsep}{\bibitemsep}%
    \setlength{\parsep}{\bibparsep}}%
  \renewcommand*{\makelabel}[1]{\hss\hspace{\dimexpr%
      \labelnumberwidth+\labelsep}##1}}
{\endlist}
{\item}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../main"
%%% End:
