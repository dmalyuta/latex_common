% ..:: Colors ::..

\makeatletter

\definecolor{csm@intro@first@char}{HTML}{df9434}
\definecolor{csm@sidebar@bg}{HTML}{f2e9c4}
\definecolor{csm@sidebar@first@char}{HTML}{a08c2f}
\definecolor{csm@fig@bg}{HTML}{e6f7fe}
\definecolor{@light@blue}{HTML}{26baf2}
\colorlet{csm@fig@label@body}{@light@blue}
\colorlet{csm@blurb@color}{@light@blue}
\definecolor{@golden}{HTML}{c8b03b}
\colorlet{csm@fig@label@sidebar}{@golden}
\colorlet{csm@abstract@color}{@golden}
\definecolor{csm@table@caption@bg}{HTML}{abc2e9}
\definecolor{csm@table@border}{HTML}{5e81c9}
\colorlet{csm@table@bg}{csm@fig@bg}

\makeatother

% ..:: Paragraphs ::..

\makeatletter
\def\@csm@parindent{1em}
\def\@csm@parskip{0pt plus1pt}

\setlength\parindent{\@csm@parindent} % Paragraph indentation
\setlength{\parskip}{\@csm@parskip} % Paragraph spacing

\makeatother

% ..:: Fonts ::..

% \let\transp\relax
% \usepackage{newtxmath}
\let\temp\rmdefault
\usepackage{mathpazo}
\let\rmdefault\temp

\DeclareMathSizes{10}{9}{7}{5}

% See https://tex.stackexchange.com/a/195867/90535
\DeclareSymbolFont{Greekletters}{OT1}{iwona}{m}{n}
\DeclareSymbolFont{greekletters}{OML}{iwona}{m}{it}
\DeclareMathSymbol{\Delta}{\mathord}{Greekletters}{"01}
\DeclareMathSymbol{\Theta}{\mathord}{Greekletters}{"02}
\DeclareMathSymbol{\Lambda}{\mathord}{Greekletters}{"03}
\DeclareMathSymbol{\Xi}{\mathord}{Greekletters}{"04}
\DeclareMathSymbol{\Pi}{\mathord}{Greekletters}{"05}
\DeclareMathSymbol{\Sigma}{\mathord}{Greekletters}{"06}
\DeclareMathSymbol{\Upsilon}{\mathord}{Greekletters}{"07}
\DeclareMathSymbol{\Phi}{\mathord}{Greekletters}{"08}
\DeclareMathSymbol{\Psi}{\mathord}{Greekletters}{"09}
\DeclareMathSymbol{\Omega}{\mathord}{Greekletters}{"0A}
\DeclareMathSymbol{\alpha}{\mathord}{greekletters}{"0B}
\DeclareMathSymbol{\beta}{\mathord}{greekletters}{"0C}
\DeclareMathSymbol{\gamma}{\mathord}{greekletters}{"0D}
\DeclareMathSymbol{\delta}{\mathord}{greekletters}{"0E}
\DeclareMathSymbol{\epsilon}{\mathord}{greekletters}{"0F}
\DeclareMathSymbol{\zeta}{\mathord}{greekletters}{"10}
\DeclareMathSymbol{\eta}{\mathord}{greekletters}{"11}
\DeclareMathSymbol{\theta}{\mathord}{greekletters}{"12}
\DeclareMathSymbol{\iota}{\mathord}{greekletters}{"13}
\DeclareMathSymbol{\kappa}{\mathord}{greekletters}{"14}
\DeclareMathSymbol{\lambda}{\mathord}{greekletters}{"15}
\DeclareMathSymbol{\mu}{\mathord}{greekletters}{"16}
\DeclareMathSymbol{\nu}{\mathord}{greekletters}{"17}
\DeclareMathSymbol{\xi}{\mathord}{greekletters}{"18}
\DeclareMathSymbol{\pi}{\mathord}{greekletters}{"19}
\DeclareMathSymbol{\rho}{\mathord}{greekletters}{"1A}
\DeclareMathSymbol{\sigma}{\mathord}{greekletters}{"1B}
\DeclareMathSymbol{\tau}{\mathord}{greekletters}{"1C}
\DeclareMathSymbol{\upsilon}{\mathord}{greekletters}{"1D}
\DeclareMathSymbol{\phi}{\mathord}{greekletters}{"1E}
\DeclareMathSymbol{\chi}{\mathord}{greekletters}{"1F}
\DeclareMathSymbol{\psi}{\mathord}{greekletters}{"20}
\DeclareMathSymbol{\omega}{\mathord}{greekletters}{"21}
\DeclareMathSymbol{\varepsilon}{\mathord}{greekletters}{"22}
\DeclareMathSymbol{\vartheta}{\mathord}{greekletters}{"23}
\DeclareMathSymbol{\varpi}{\mathord}{greekletters}{"24}
\DeclareMathSymbol{\varrho}{\mathord}{greekletters}{"25}
\DeclareMathSymbol{\varsigma}{\mathord}{greekletters}{"26}
\DeclareMathSymbol{\varphi}{\mathord}{greekletters}{"27}

% Fix the prime symbol
% \newcommand\der{\mkern+0mu\raise-0.0ex\hbox{$\scriptstyle\prime$}}
\newcommand\der{^{\mkern+2.5mu\raise-3pt\hbox{$\scriptstyle\prime$}}}
\newcommand\dder{\der\der}
\newcommand\ddder{\der\der\der}
\newcommand\dddder{\der\der\der\der}

% ..:: Lists ::..

\tikzset{
  list bullet/.style={
    scale=0.5
  }
}

\setlist[itemize,1]{label={%
    \tikz[outer sep=0,inner sep=0,baseline=-0.3em]{%
      \node[list bullet] at (0,0) {\faChevronRight};%
      \node[list bullet] at (0.25em,0) {\faChevronRight};}%
  },leftmargin=1.3em}

% ..:: Page geometry ::..

\usepackage{geometry}

\ExplSyntaxOn
\tl_set:Nn \l_sidemargin_dim {1.5cm}
\tl_set:Nn \l_topmargin_dim {2.2cm}
\tl_set:Nn \l_botmargin_dim {1.6cm}
\tl_set:Nn \l_footmargin_dim {6mm}
\tl_set:Nn \l_columnsep_dim {3mm}
\geometry{
  papersize={200mm,273mm},
  twocolumn,
  left=\tl_use:N \l_sidemargin_dim,
  right=\tl_use:N \l_sidemargin_dim,
  top=\tl_use:N \l_topmargin_dim,
  bottom=\tl_use:N \l_botmargin_dim,
  footskip=\tl_use:N \l_footmargin_dim,
  columnsep=\tl_use:N \l_columnsep_dim
}
\ExplSyntaxOff

% ..:: Section titles ::..

\usepackage{helvet}
\titleformat{\section}{%
  \normalfont\fontsize{10}{12}%
  \sffamily\bfseries\MakeUppercase}{}{0cm}{#1}
\titlespacing*{\section}{0cm}{4mm}{0mm}

\titleformat{\subsection}{%
  \normalfont\fontsize{10}{12}%
  \sffamily\bfseries\slshape}{}{0cm}{#1}
\titlespacing*{\subsection}{0cm}{4mm}{0mm}

\titleformat{\subsubsection}{%
  \normalfont\fontsize{10}{12}%
  \sffamily}{}{0cm}{#1}
\titlespacing*{\subsubsection}{0cm}{4mm}{0mm}

% >> Opening text <<

\makeatletter

\newcommand{\firstword}[2][]{%
  \StrChar{#2}{1}[\first@char]%
  \StrBehind{#2}{\first@char}[\rest@of@word]%
  \renewcommand{\LettrineFontHook}{\sffamily\bfseries}%
  \lettrine[lines=5,#1]{%
    \color{csm@intro@first@char}%
    \first@char}{\rest@of@word}%
}

\makeatother

% ..:: Header and footer ::..

\usepackage{fontawesome}

\ExplSyntaxOn
\tl_new:N \l_csm_date
\tl_set:Nn \l_csm_date {}

\newcommand{\csmdate}[1]{
  \tl_set:Nn \l_csm_date {#1}
}

\fancypagestyle{csmfancy}{%
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
  \fancyfoot[LO]{%
    \sffamily%
    \fontsize{9}{11}%
    \textbf{\thepage}~~%
    \fontsize{6}{8}%
    \textbf{IEEE~CONTROL~SYSTEMS}~~%
    \tikz[outer~sep=0,inner~sep=0]{%
      \node[scale=0.8] at (0,0) {\faChevronRight};%
      \node[scale=0.8] at (0.4em,0) {\faChevronRight};}%
    {\normalfont\sffamily{}~\tl_use:N \l_csm_date}%
  }%
  \fancyfoot[RE]{%
    \fontsize{6}{8}%
    \sffamily%
    {\tl_use:N \l_csm_date}~%
    \tikz[outer~sep=0,inner~sep=0]{%
      \node[scale=0.8] at (0,0) {\faChevronLeft};%
      \node[scale=0.8] at (0.4em,0) {\faChevronLeft};}%
    \textbf{~IEEE~CONTROL~SYSTEMS}%
    \fontsize{9}{11}%
    \textbf{~~\thepage}%
  }%
}
\pagestyle{csmfancy}
\ExplSyntaxOff

% ..:: Equations ::..

\allowdisplaybreaks

% ..:: Theorem environments ::..

\makeatletter

% >> Set the theorem environment style <<

\newtheoremstyle{csm@theorem@style}% name
{4mm}% Space above
{1pt}% Space below
{}% Body font
{}% Indent amount
{\fontsize{9}{11}\sffamily}% Theorem head font
{}% Punctuation after theorem head
{\newline}% Space after theorem head
{}% Theorem head spec(can be left empty, meaning ‘normal’)

\theoremstyle{csm@theorem@style}

% >> Define the "basic" theorem environments <<

\newtheorem{csm@theorem}{Theorem}
\newtheorem{csm@lemma}{Lemma}
\newtheorem{csm@corollary}{Corollary}
\newtheorem{csm@proposition}{Proposition}
\newtheorem{csm@remark}{Remark}
\newtheorem{csm@property}{Property}
\newtheorem{csm@condition}{Condition}
\newtheorem{csm@method}{Method}
\newtheorem{csm@example}{Example}
\newtheorem{csm@problem}{Problem}
\newtheorem{csm@definition}{Definition}
\newtheorem{csm@assumption}{Assumption}

% >> Update basic theorem environments with extra elements <<

\def\@thmenvs{theorem,lemma,corollary,proposition,remark,property,%
  condition,method,example,problem,definition,assumption}

\foreach \@te in \@thmenvs {
  \bgroup
  \globaldefs=1
  % Save the original definition
  \expandafter\let\csname ocsm@\@te\expandafter\endcsname
  \csname csm@\@te\endcsname
  \expandafter\let\csname eocsm@\@te\expandafter\endcsname
  \csname endcsm@\@te\endcsname
  % Re-define the environment
  \renewenvironment{\@te}[1][]{%
    \csname ocsm@\@currenvir\endcsname%
    \ifthenelse{\equal{##1}{}}{}{\label{\@currenvir:##1}}
  }{%
    \hfill$\blacksquare$% % "QED"
    \expandafter\csname eocsm@\@currenvir\endcsname%
  }
  \egroup
}

\makeatother

% ..:: Figures ::..

\ExplSyntaxOn
\makeatletter

\tl_new:N \l_csm_figure_label_tl
\tl_new:N \l_csm_figure_caption_tl
\tl_new:N \l_csm_figure_pos_tl
\tl_new:N \l_csm_figure_cols_tl

\newtcolorbox{figurebox}{
  % Drawing engine
  enhanced~jigsaw,
  % Sizes
  width=\linewidth,
  arc=2mm,
  boxrule=0pt,
  titlerule=0pt,
  left=3mm,
  right=3mm,
  bottom=3mm,
  top=3mm,
  boxsep=\tcb@boxsep,
  % Colors
  colback=csm@fig@bg,
  colbacktitle=csm@fig@bg
}

\define@key{csm@figure@keys}{label}{\tl_set:Nn \l_csm_figure_label_tl {#1}}
\define@key{csm@figure@keys}{caption}{\tl_set:Nn \l_csm_figure_caption_tl {#1}}
\define@key{csm@figure@keys}{position}{\tl_set:Nn \l_csm_figure_pos_tl {#1}}
\define@key{csm@figure@keys}{columns}{\tl_set:Nn \l_csm_figure_cols_tl {#1}}

% Caption style
\captionsetup[figure]{font={footnotesize,sf},labelfont={},
  name={\bfseries\color{csm@fig@label@body}FIGURE~},labelsep=space}

% Figure selector
\newenvironment{figure@internal}[2][tbp]{%
  \def\fig@width{#2}%
  \ifthenelse{\equal{\fig@width}{}}{%
    \begin{figure}[#1]}{\begin{figure*}[#1]}}{%
      \ifthenelse{\equal{\fig@width}{}}{%
      \end{figure}}{\end{figure*}}}

\newenvironment{csmfigure}[1][]{%
  % Options
  \setkeys{csm@figure@keys}{label=,#1}%
  \setkeys{csm@figure@keys}{caption=,#1}%
  \setkeys{csm@figure@keys}{position=tbp,#1}%
  \setkeys{csm@figure@keys}{columns=1,#1}%
  % Parse options
  \edef\csm@fig@pos{\tl_use:N \l_csm_figure_pos_tl}%
  \pgfmathparse{\tl_use:N \l_csm_figure_cols_tl ==1 ? 1:0}%
  \ifthenelse{\pgfmathresult>0}{%
    \gdef\csm@figure@width{}%
  }{%
    \gdef\csm@figure@width{dbl}%
  }%
  % Make igure
  \edef\begin@figure@cmd{{figure@internal}[\csm@fig@pos}%
  \expandafter\begin\begin@figure@cmd]{\csm@figure@width}%
    \begin{figurebox}
    }{%
    \end{figurebox}
    \caption{\tl_use:N \l_csm_figure_caption_tl}
    \figlabel{\tl_use:N \l_csm_figure_label_tl}
  \end{figure@internal}
}

\makeatother
\ExplSyntaxOff

% ..:: Tables ::..

\ExplSyntaxOn
\makeatletter

\tl_new:N \l_csm_table_label_tl
\tl_new:N \l_csm_table_caption_tl
\tl_new:N \l_csm_table_pos_tl
\tl_new:N \l_csm_table_cols_tl

\def\@table@inner@pad{3mm}
\def\@table@border@width{1pt}

\newtcolorbox{tablebox}[1][]{
  % Drawing engine
  enhanced~jigsaw,
  % Fonts
  fonttitle=\sffamily\bfseries\small,
  fontupper=\sffamily,
  % Sizes
  width=\linewidth,
  arc=2mm,
  boxrule=\@table@border@width,
  titlerule=\@table@border@width,
  left=\@table@inner@pad,
  right=\@table@inner@pad,
  bottom=\@table@inner@pad,
  top=\@table@inner@pad,
  toptitle=\@table@inner@pad,
  bottomtitle=\@table@inner@pad,
  boxsep=\tcb@boxsep,
  % Colors
  colback=csm@table@bg,
  coltitle=black,
  colbacktitle=csm@table@caption@bg,
  colframe=csm@table@border,
  % Title
  title={#1},
  attach~boxed~title~to~top,
  boxed~title~style={colframe=csm@table@border,rounded~corners}
}

\define@key{csm@table@keys}{label}{\tl_set:Nn \l_csm_table_label_tl {#1}}
\define@key{csm@table@keys}{caption}{\tl_set:Nn \l_csm_table_caption_tl {#1}}
\define@key{csm@table@keys}{position}{\tl_set:Nn \l_csm_table_pos_tl {#1}}
\define@key{csm@table@keys}{columns}{\tl_set:Nn \l_csm_table_cols_tl {#1}}

% Figure selector
\newenvironment{table@internal}[2][tbp]{%
  \def\table@width{#2}%
  \ifthenelse{\equal{\table@width}{}}{%
    \begin{table}[#1]}{\begin{table*}[#1]}}{%
      \ifthenelse{\equal{\table@width}{}}{%
      \end{table}}{\end{table*}}}

\newenvironment{csmtable}[1][]{%
  % Options
  \setkeys{csm@table@keys}{label=,#1}%
  \setkeys{csm@table@keys}{caption=,#1}%
  \setkeys{csm@table@keys}{position=tbp,#1}%
  \setkeys{csm@table@keys}{columns=1,#1}%
  % Parse options
  \edef\csm@table@pos{\tl_use:N \l_csm_table_pos_tl}%
  \pgfmathparse{\tl_use:N \l_csm_table_cols_tl ==1 ? 1:0}%
  \ifthenelse{\pgfmathresult>0}{%
    \gdef\csm@table@width{}%
  }{%
    \gdef\csm@table@width{dbl}%
  }%
  % Make figure
  \edef\begin@table@cmd{{table@internal}[\csm@table@pos}%
    \expandafter\begin\begin@table@cmd]{\csm@table@width}%
    \refstepcounter{table}
    \begin{tablebox}[%
      {\bfseries TABLE~\arabic{table}}\hspace{1em}%
      \tl_use:N \l_csm_table_caption_tl]%
      \fontsize{9}{13}%
    }{%
    \end{tablebox}
    \tablabel{\tl_use:N \l_csm_table_label_tl}
  \end{table@internal}
}

% ..:: Referencing ::..

\makeatletter

% Source: https://tex.stackexchange.com/a/168835/90535
\let\oldhypertarget\hypertarget
\renewcommand{\hypertarget}[2]{%
  \oldhypertarget{#1}{#2}%
  \protected@write\@mainaux{}{%
    \string\expandafter\string\gdef
    \string\csname\string\detokenize{#1}\string\endcsname{#2}%
  }%
}

\newcommand{\csmhyperlink}[1]{%
  \hyperlink{#1}{\csname #1\endcsname}%
}

\makeatother

% ..:: Sidebars ::..

\ExplSyntaxOn
\makeatletter

\tl_new:N \l_csm_sidebar_title_tl
\tl_new:N \l_csm_sidebar_label_tl
\tl_new:N \l_csm_sidebar_side_tl
\tl_new:N \l_csm_sidebar_pos_tl
\tl_new:N \l_csm_sidebar_cols_tl

\define@key{csm@sidebar@keys}{title}{\tl_set:Nn \l_csm_sidebar_title_tl {#1}}
\define@key{csm@sidebar@keys}{label}{\tl_set:Nn \l_csm_sidebar_label_tl {#1}}
\define@key{csm@sidebar@keys}{side}{\tl_set:Nn \l_csm_sidebar_side_tl {#1}}
\define@key{csm@sidebar@keys}{position}{\tl_set:Nn \l_csm_sidebar_pos_tl {#1}}
\define@key{csm@sidebar@keys}{columns}{\tl_set:Nn \l_csm_sidebar_cols_tl {#1}}

\newcounter{sidebar@equation}%
\newcounter{sidebar@table}%
\newcounter{sidebar@figure}%
\newcounter{subsidebar@counter}

\setcounter{subsidebar@counter}{0}

\newsavebox{\sidebar@box@full}
\newsavebox{\sidebar@box@left}
\newsavebox{\sidebar@box@right}

\def\tcb@left{1em}
\def\tcb@right{1em}
\def\tcb@bottom{1em}
\def\tcb@boxsep{0pt}
\def\tcb@leftfill{0cm}
\def\tcb@rightfill{0cm}

\def\continued@message{\textit{(continued...)}}

\newtcolorbox{sidebarbox}[1][]{
  % Drawing engine
  enhanced~jigsaw,
  % Fonts
  fonttitle=\sffamily\bfseries\large,
  % Sizes
  width=#1,
  arc=2mm,
  boxrule=0pt,
  titlerule=0pt,
  toptitle=2mm,
  left=\tcb@left,
  right=\tcb@right,
  bottom=\tcb@bottom,
  boxsep=\tcb@boxsep,
  leftrule=\tcb@leftfill,
  grow~to~left~by=\tcb@leftfill,
  rightrule=\tcb@rightfill,
  grow~to~right~by=\tcb@rightfill,
  % Colors
  colback=csm@sidebar@bg,
  colframe=csm@sidebar@bg,
  colbacktitle=csm@sidebar@bg,
  coltitle=black
}

\newenvironment{sidebar}[1][]{%
  % Raw options
  \setkeys{csm@sidebar@keys}{title=,#1}%
  \setkeys{csm@sidebar@keys}{label=,#1}%
  \setkeys{csm@sidebar@keys}{side=odd,#1}%
  \setkeys{csm@sidebar@keys}{position=t,#1}%
  \setkeys{csm@sidebar@keys}{columns=2,#1}%
  % Parse options
  \edef\sidebar@side{\tl_use:N \l_csm_sidebar_side_tl}%
  \edef\fig@pos{\tl_use:N \l_csm_sidebar_pos_tl}%
  \pgfmathparse{\tl_use:N \l_csm_sidebar_cols_tl ==1 ? 1:0}%
  \ifthenelse{\pgfmathresult>0}{%
    \gdef\figure@width{}%
    \tikzmath{\sidebar@box@width=\columnwidth;
      \sidebar@width=\sidebar@box@width-\tcb@left-\tcb@right-\tcb@boxsep;}
    \xdef\sidebar@box@width{\sidebar@box@width pt}%
    \xdef\sidebar@width{\sidebar@width pt}%
  }{%
    \gdef\figure@width{dbl}%
    \tikzmath{\sidebar@box@width=\textwidth;
      \sidebar@width=\sidebar@box@width-\tcb@left-\tcb@right-\tcb@boxsep;}
    \xdef\sidebar@box@width{\sidebar@box@width pt}%
    \xdef\sidebar@width{\sidebar@width pt}%
  }%
  % Create the box
  \begin{subsidebar}[reset]%
  }{%
  \end{subsidebar}%
  % Draw sidebar
  \pgfmathparse{\value{subsidebar@counter}==1 ? 1:0}%
  \ifthenelse{\pgfmathresult>0}{%
    % Show full content in one sidebar
    \sidebar@draw{none}{\sidebar@box@full}%
  }{%
    % Show left and right content in separate sidebars
    \ifthenelse{\equal{\sidebar@side}{odd}}{%
      \def\sidebar@side@other{even}%
    }{%
      \def\sidebar@side@other{odd}%
    }%
    \sidebar@draw{\sidebar@side}{\sidebar@box@left}%
    \sidebar@draw[notitle]{\sidebar@side@other}{\sidebar@box@right}%
  }%
  % Reset counter
  \setcounter{subsidebar@counter}{0}
}

\newcommand{\sidebar@draw}[3][title]{
  \xdef\sidebar@title{\tl_use:N \l_csm_sidebar_title_tl}%
  \xdef\sidebar@label{sidebar:\tl_use:N \l_csm_sidebar_label_tl}%
  \edef\begin@sidebar@cmd{{figure@internal}[\fig@pos}%
  \expandafter\begin\begin@sidebar@cmd]{\figure@width}%
    \ifthenelse{\equal{#1}{title}}{%
      \tcbset{%
        title={\hypertarget{\sidebar@label}{\sidebar@title}}
      }%
    }{}%
    \ifthenelse{\equal{#2}{none}}{%
      \def\tcb@leftfill{0cm}%
      \def\tcb@rightfill{0cm}%
    }{%
      \ifthenelse{\equal{#2}{odd}}{%
        \def\tcb@leftfill{0cm}%
        \def\tcb@rightfill{10cm}%
      }{%
        \def\tcb@leftfill{10cm}%
        \def\tcb@rightfill{0cm}%
      }%
    }%
    \begin{sidebarbox}[\sidebar@box@width]%
      \usebox{#3}%
    \end{sidebarbox}%
  \end{figure@internal}%
}

\newenvironment{subsidebar}[1][noreset]{
  % Options
  \def\sidebar@reset{#1}
  % Check if too many subsidebars
  \pgfmathparse{\value{subsidebar@counter}>=3 ? 1:0}%
  \ifthenelse{\pgfmathresult>0}{%
    \PackageError{CSM~style}{Only~two~subsidebars~are~allowed}{}%
  }{}%
  % Get the box name to save content to
  \pgfmathparse{\value{subsidebar@counter}==0 ? 1:0}%
  \ifthenelse{\pgfmathresult>0}{%
    \def\sidebar@box{sidebar@box@full}%
  }{%
    \pgfmathparse{\value{subsidebar@counter}==1 ? 1:0}%
    \ifthenelse{\pgfmathresult>0}{%
      \def\sidebar@box{sidebar@box@left}%
    }{%
      \def\sidebar@box{sidebar@box@right}%
    }%
  }%
  % Increment the counter
  \stepcounter{subsidebar@counter}%
  % Create the box
  \begin{lrbox}{\csname\sidebar@box\endcsname}%
    \begin{minipage}{\sidebar@width}%
      \ifthenelse{\equal{\sidebar@reset}{noreset}}{}{%
        % Reset equation, table, and figure counters and make labels start
        % with an "S"
        \global\chardef\dc@currentequation=\value{equation}%
        \global\chardef\dc@currentfigure=\value{figure}%
        \global\chardef\dc@currenttable=\value{table}%
        \let\c@equation\c@sidebar@equation
        \let\c@figure\c@sidebar@figure
        \let\c@table\c@sidebar@table
        \renewcommand{\theequation}{S\arabic{equation}}%
        \renewcommand{\thetable}{S\arabic{table}}%
        \renewcommand{\thefigure}{S\arabic{figure}}%
        \renewcommand{\theHequation}{S\arabic{equation}}%
        \renewcommand{\theHtable}{S\arabic{table}}%
        \renewcommand{\theHfigure}{S\arabic{figure}}%
      }%
      % Set columns
      \ifthenelse{\equal{\figure@width}{}}{}{%
        \begin{multicols}{2}%
        }%
        % Set font
        \fontsize{9}{13}
        \setlength\parindent{\@csm@parindent} % Paragraph indentation
        \setlength{\parskip}{\@csm@parskip} % Paragraph spacing
        % \renewcommand\familydefault\sfdefault
        \sffamily\sansmath
        \captionsetup[figure]{name={%
            \bfseries\color{csm@fig@label@sidebar}FIGURE~}}
        % Print "continued" if this is the second subsidebar panel
        \pgfmathparse{\value{subsidebar@counter}==3 ? 1:0}%
        \ifthenelse{\pgfmathresult>0}{%
          \continued@message%
        }{}%
        % Main text body (given environment body) ...
      }{%
        % ... End of main text body
        \pgfmathparse{\value{subsidebar@counter}!=2 ? 1:0}
        \ifthenelse{\pgfmathresult>0}{%
          \edef\sidebar@bib@label{sidebar:\tl_use:N \l_csm_sidebar_label_tl}%
          % Print the bibliography, citations start with an "S"
          \begin{refcontext}[sorting=none,labelprefix=S]
            \AtNextBibliography{\fontsize{7}{9}\sffamily}%
            \DeclareFieldFormat{labelnumberwidth}{[##1]}
            \begingroup\edef\sidebar@print@bib{\endgroup\noexpand
              \printbibliography[title=References,
              keyword=\sidebar@bib@label,
              resetnumbers=false]
            }\sidebar@print@bib
          \end{refcontext}
          % \AtNextBibliography{\footnotesize}%
          % \begingroup\edef\sidebar@print@bib{\endgroup\noexpand
          %   \printbibliography[title=References,
          %   keyword=\sidebar@bib@label]
          % }\sidebar@print@bib
        }{}%
        % Print "continued" if this is the first subsidebar panel
        \ifthenelse{\pgfmathresult>0}{}{%
          \continued@message%
        }%
        % End columns
        \ifthenelse{\equal{\figure@width}{}}{}{%
        \end{multicols}%
      }%
      \ifthenelse{\equal{\sidebar@reset}{noreset}}{}{%
        % Reset equation, table, and figure counters to body text values
        \edef\equation@mem{\arabic{sidebar@equation}}%
        \edef\figure@mem{\arabic{sidebar@figure}}%
        \edef\table@mem{\arabic{sidebar@table}}%
        \setcounter{equation}{\dc@currentequation}%
        \setcounter{figure}{\dc@currentfigure}%
        \setcounter{table}{\dc@currenttable}%
        \setcounter{sidebar@equation}{\equation@mem}%
        \setcounter{sidebar@figure}{\figure@mem}%
        \setcounter{sidebar@table}{\table@mem}%
      }%
    \end{minipage}%
  \end{lrbox}%
  % Save the box for global access
  \global%
  \expandafter\setbox\csname\sidebar@box\endcsname%
  \expandafter\box\csname\sidebar@box\endcsname%
}

\renewcommand*{\LettrineTextFont}{}
\newcommand{\sbfirstword}[1]{%
  \StrChar{#1}{1}[\first@char]%
  \StrBehind{#1}{\first@char}[\rest@of@word]%
  \lettrine[nindent=0pt,slope=0pt,findent=3pt]{%
    \color{csm@sidebar@first@char}\bfseries%
    \first@char}{\rest@of@word}%
}

\newcommand{\sbref}[1]{%
  \@ifundefined{sidebar:#1}{%
    ``\textbf{??}''%
  }{%
    ``\csmhyperlink{sidebar:#1}''%
  }%
}

\makeatother
\ExplSyntaxOff

% ..:: Highlight text blurb ::..

\makeatletter

\def\blurb@pad{4mm}

\newtcolorbox{blurbbox}{
  % Drawing engine
  enhanced jigsaw,
  % Fonts
  fontupper=\sffamily\bfseries\large,
  % Sizes
  width=\textwidth,
  arc=2mm,
  boxrule=0.5pt,
  titlerule=0pt,
  toptitle=2mm,
  left=\blurb@pad,
  right=\blurb@pad,
  bottom=\blurb@pad,
  top=\blurb@pad,
  boxsep=0pt,
  % Colors
  opacityback=0,
  colframe=csm@blurb@color,
  coltext=csm@blurb@color
}

\newenvironment{blurb}{
  \begin{figure*}[!t]
    \centering
    \begin{blurbbox}
      \centering
      \setlength{\baselineskip}{1.4em}
    }{
    \end{blurbbox}
  \end{figure*}
}

\makeatother

% ..:: Abstract (which will not appear in print) ::..

\makeatletter

\def\abstract@pad{2mm}

\newtcolorbox{abstractbox}{
  % Drawing engine
  enhanced jigsaw,
  % Fonts
  fontupper=\sffamily,
  % Sizes
  width=\textwidth,
  arc=2mm,
  boxrule=0.5pt,
  titlerule=0pt,
  toptitle=2mm,
  left=\abstract@pad,
  right=\abstract@pad,
  bottom=\abstract@pad,
  top=\abstract@pad,
  boxsep=0pt,
  % Colors
  opacityback=0,
  colframe=csm@abstract@color,
  coltext=black!70
}

\newenvironment{csmabstract}{
  \begin{figure*}[t]
    \centering
    \begin{abstractbox}%
      \paragraph{\sffamily Abstract (hidden in print).}%
    }{%
    \end{abstractbox}
  \end{figure*}
}

\makeatother

% ..:: Nomenclature ::..

\ExplSyntaxOn
\makeatletter

\tl_new:N \l_csm_nomenclature_title_tl
\tl_new:N \l_csm_nomenclature_label_tl
\tl_new:N \l_csm_nomenclature_first_col_width_tl
\tl_new:N \l_csm_nomenclature_position_tl

\define@key{csm@nomenclature@keys}{title}{\tl_set:Nn
  \l_csm_nomenclature_title_tl {#1}}
\define@key{csm@nomenclature@keys}{label}{\tl_set:Nn
  \l_csm_nomenclature_label_tl {#1}}
\define@key{csm@nomenclature@keys}{width}{\tl_set:Nn
  \l_csm_nomenclature_first_col_width_tl {#1}}
\define@key{csm@nomenclature@keys}{position}{\tl_set:Nn
  \l_csm_nomenclature_position_tl {#1}}

\NewEnviron{csmnomenclature}[1][]{
  \setkeys{csm@nomenclature@keys}{title=,#1}%
  \setkeys{csm@nomenclature@keys}{label=,#1}%
  \setkeys{csm@nomenclature@keys}{width=0.2,#1}%
  \setkeys{csm@nomenclature@keys}{position=t,#1}%
  \edef\nomenc@title{\tl_use:N
    \l_csm_nomenclature_title_tl}%
  \edef\nomenc@label{\tl_use:N
    \l_csm_nomenclature_label_tl}%
  \edef\nomenc@width{\tl_use:N
    \l_csm_nomenclature_first_col_width_tl}%
  \edef\nomenc@position{\tl_use:N
    \l_csm_nomenclature_position_tl}%
  \def\@nomenclature@content{\BODY}
  \begin{sidebar}[%
    title={\nomenc@title},%
    columns=1,%
    label={\nomenc@label},
    position={\nomenc@position}]%
    \footnotesize
    \def\arraystretch{1.2}
    \newcolumntype{V}{>{\hsize=\nomenc@width\linewidth}X}
    \begin{tabularx}{\columnwidth}{VX}
      \@nomenclature@content
    \end{tabularx}
  \end{sidebar}
}

\makeatother
\ExplSyntaxOff

% ..:: Author biography ::..

\newenvironment{authorbio}[1][]{
  {\bfseries\itshape #1}~}{}

% ..:: Bibliography ::..

\setlength{\biblabelsep}{1mm}
\setlength\bibitemsep{0.1\baselineskip}

% Remove hanging indent
% Source: https://tex.stackexchange.com/a/400666/90535
\defbibenvironment{bibliography}
{\list
  {\printtext[labelnumberwidth]{%
      \printfield{labelprefix}%
      \printfield{labelnumber}}}
  {\setlength{\labelwidth}{\labelnumberwidth}%
    \setlength{\leftmargin}{0pt}%{\labelwidth}%
    \setlength{\labelsep}{\biblabelsep}%
    \setlength{\itemsep}{\bibitemsep}%
    \setlength{\parsep}{\bibparsep}}%
  \renewcommand*{\makelabel}[1]{\hss\hspace{\dimexpr%
      \labelnumberwidth+\labelsep}##1}}
{\endlist}
{\item}

\newcommand{\csmprintmainbib}{
  \begin{refcontext}[sorting=none]
    \AtNextBibliography{\footnotesize}%
    \DeclareFieldFormat{labelnumberwidth}{[##1]}
    \printbibliography[notkeyword=sidebarbib, resetnumbers=true]
  \end{refcontext}
}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../main"
%%% End:
